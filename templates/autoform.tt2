<head>
<script type="text/javascript" src="/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="/jscript/jquery.poshytip.min.js"></script>
<link href="/css/tip-yellowsimple.css" rel="stylesheet" type="text/css">
<link href="/css/tip-redsimple.css" rel="stylesheet" type="text/css">
<link href="/css/autoform.css" rel="stylesheet" type="text/css">

[% IF (special.with_map.0) %]
<script src="https://api-maps.yandex.ru/1.1/index.xml" type="text/javascript"></script>
[% END %]

[% IF (special.datepicker.0 || special.post_index.0 ) %]
	<script type="text/javascript" src="/jquery-ui.1.8.min.js"></script>
	<link href="/jquery-ui-1.8.16.custom.css" rel="stylesheet" type="text/css">
	<style>.ui-datepicker-trigger{ margin-left:4px; }</style>
[% END %]

[% IF special.mask.0 %]
	<script type="text/javascript" src="/jquery.maskedinput.min.js"></script>
[% END %]

[% IF javascript_check %]
<noscript>
	<meta http-equiv="refresh" content="0; url=[% addr %]?t=[% token %]&script=no">
</noscript>
[% ELSE %]
<script>
	window.location.href = "[% addr %]?t=[% token %]";
</script>
[% END %]
</head>

<font face="arial">

<center>
<div id="app_form" style = "margin: 50px ">

<form action = "[% addr %]?t=[% token %][% IF lang_in_link %]&lang=[% lang_in_link %][% END %]" method = "POST" name = "dataform">
<input type = "hidden" value = "nothing" name = "action" id = "action">
<input type = "hidden" value = "[% mobile_app %]" name = "mobile_app" id = "mobile_app">

<table width="100%">

<tr><td><table id="progressbar" class="progressbar_gen"><tr>[% progress %]<tr></table><br><br><br><td><tr>

<tr><td align="center">
<table width="590px" id="app_table">

<tr><td colspan="3"><h2>[% langreq(title) %]</h2><br></td></tr>

[% content_text %]

[% IF (special.with_map.0) %]
<tr class="ymap"><td colspan="3">&nbsp;</td></tr>
<tr class="ymap"><td colspan="3"><div id="YMapsID" style="width:100%;height:400px"></div></td></tr>
<tr class="ymap"><td colspan="3">&nbsp;</td></tr>

<script type="text/javascript">
YMaps.jQuery(function () {
	var map = new YMaps.Map(YMaps.jQuery("#YMapsID")[0]);
	map.setCenter(new YMaps.GeoPoint([% map_in_page.1 %], [% map_in_page.0 %]), 16);
	map.openBalloon(new YMaps.GeoPoint([% map_in_page.1 %], [% map_in_page.0 %]), "[% map_in_page.2 %]");
	map.addControl(new YMaps.Zoom());
});
</script>
[% END %]

<tr><td colspan="3"><br>
[% IF ( step > min_step ) && ( step != max_step ) %]
	<input type="button" value="◁ [% langreq('Назад') %]" onclick="go_button('back');">
	&nbsp;
[% END %]
[% IF ( step < max_step ) && ( step > 0 ) %]
	<input id="next_button" type="button" value="[% langreq('Далее') %] ▷" onclick="go_button('forward');">
[% END %]

[% IF ( step == max_step ) %]
	[% IF mobile_app %]
		<input type="button" value="[% langreq('Завершить запись и вернуться в приложение') %] ▷" onclick="go_button('mobile_app');">
	[% ELSE %]
		<input type="button" value="[% langreq('Перейти на страницу записи') %] ▷" onclick="go_button('app');">
	[% END %]
[% END %]
[% IF step %]
</td></tr><tr><td colspan="3">&nbsp;</td></tr>
<tr><td colspan="3">
	[% IF ( step == 1 ) %]
	<a target="_blank" class="dotted_link_big" href="">[% langreq('Воспользуйтесь преимуществами услуги Vip Premium lounge') %]</a>
	<br>
	[% END %]
<a target="_blank" class="dotted_link" href="">[% langreq('Отказ от ответственности и политика конфиденциальности') %]</a>
[% END %]
</td></tr></table>

</td></tr></table>

</form>

<script>

$(window).resize(mobileScreenCheck);
$(document).ready(mobileScreenCheck);

function isMobile() {
	return (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
}

function mobileScreenCheck() {

	var mobilScreen = isMobile();	
	
	if ( mobilScreen ) {
		init_comm( 'center', 'bottom' );
	}
	else {
		init_comm( 'right', 'center' );
	};
	
	$('#app_table').attr("cellspacing", ( mobilScreen ? '50' : '' ) );
	$('#app_table').attr("width", ( mobilScreen ? '100%' : '590px' ) );
	
	$('.input_width').css( "width", ( mobilScreen ? '100%' : '20em' ) );
	
	$('#progressbar').css( "display", ( mobilScreen ? 'none' : 'table' ) );
	$('#app_form').css( "margin", ( mobilScreen ? '0px' : '50px' ) );
	$('.info').css( "font-size", ( mobilScreen ? '30px' : '' ) );
	
	$(':button').css( "height", ( mobilScreen ? '120px' : '' ) );
	$(':button').css( "width", ( mobilScreen ? '240px' : '' ) );
	
	$(':checkbox, :radio').css( "-ms-transform", ( mobilScreen ? "scale(4)" : "" ) );
	$(':checkbox, :radio').css( "-moz-transform:", ( mobilScreen ? "scale(4)" : "" ) );
	$(':checkbox, :radio').css( "-webkit-transform", ( mobilScreen ? "scale(4)" : "" ) );
	$(':checkbox, :radio').css( "-o-transform", ( mobilScreen ? "scale(4)" : "" ) );
	$(':checkbox, :radio').css( "margin-right", ( mobilScreen ? "30x" : "" ) );
	$(':checkbox, :radio').css( "margin-top", ( mobilScreen ? "20px" : "" ) );
	
	if ( mobilScreen ) {
		[% FOREACH picker IN special.datepicker %]
			$('#[% picker %]').datepicker('destroy');
		[% END %]
	}
	else {
		$('#ui-datepicker-div').css( "font-size", "12" );
	}
	
	[% FOREACH post_index IN special.post_index %]	
		$('#[% post_index %]').autocomplete("widget").css("width", ( mobilScreen ? 600 : 300 ));
		$('#[% post_index %]').autocomplete("widget").css({"font-size": ( mobilScreen ? '30px' : '14px' )});
	[% END %]
	
	$("#app_table").each(function(){
		$("td",this).each(function(){
			$(this).css( "display", ( mobilScreen ? 'block' : '' ) );
			$(this).css( "float", ( mobilScreen ? 'left' : '' ) );
			$(this).css( "width", ( mobilScreen ? '100%' : '' ) );
		});
	});
	
	$('*').each(function(){
		$(this).css( "font-size", mobilScreen ? '35px' : '' );
	});
	
	$('.input_width').css( "line-height", mobilScreen ? '60px' : '' );
	$('.input_width').css( "height", mobilScreen ? '60px' : '' );
	$('.input_width').css( "font-size", mobilScreen ? '40px' : '' );
	$('.input_width').css( "width", ( mobilScreen ? '100%' : '20em' ) );
	
	$('.mobil_hide').css( "display", ( mobilScreen ? 'none' : '' ) );
}


function go_button(where) {

	[% IF ( step == max_step ) %]
		if (where == 'app') {
			location.replace('[% vcs_tools %]info.htm?&token=[% token %]&appid=[% appid %][% IF lang_in_link %]&lang=[% lang_in_link %][% END %]');
			return;
		}
	[% END %]
	
	[% IF mobile_app %]
		if (where == 'mobile_app') {
			location.replace('/autoform/mobile_end.htm');
			return;
		}
	[% END %]
	
	[% IF ( ( step + 1 ) == max_step ) %]
		if (where == 'forward') {
			$('#next_button').prop('disabled', true);
		}
	[% END %]
	
	$('#action').val(where);
	document.dataform.submit();
};

function init_comm(pos_x, pos_y) {
	$('.input_gen, .select_gen,').poshytip('destroy');

	$('.input_gen').poshytip({
		className: 'tip-yellowsimple',
		showOn: 'focus',
		alignTo: 'target',
		alignX: pos_x,
		alignY: pos_y,
		offsetX: 5,
		showTimeout: 100
	});
	
	$('.select_gen,').poshytip({
		className: 'tip-yellowsimple',
		showOn: 'focus',
		alignTo: 'target',
		alignX: 'center',
		alignY: 'top',
		offsetX: 5,
		showTimeout: 100
	});
}

[% FOREACH picker IN special.datepicker %]
	$('#[% picker %]').datepicker({
		dateFormat: 'dd.mm.yy',
		firstDay: 1,
		
		showButtonPanel: true,
		beforeShow: function( input ) {
			setTimeout(function() {
				var buttonPane = $( input ).datepicker( "widget" ).find( ".ui-datepicker-buttonpane" );  
				var btn = $('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');  
				btn.unbind("click").bind("click", function () {
					$.datepicker._clearDate( input );
				});  
				btn.appendTo( buttonPane );  
			}, 1 );  
		}, 
		showOn: 'both',
		buttonImage: '/vcs/static/images/1x1.png',
		buttonImageOnly:true
	}).keyup(function(e) {
		if(e.keyCode == 8 || e.keyCode == 46) {
			$.datepicker._clearDate(this);
		}
	});
[% END %]

[% FOREACH mask IN special.mask %]
	$("#[% mask %]").mask("99.99.9999");
[% END %]

[% FOREACH near IN special.nearest_date %]
	update_nearest_date_[% near %]();
			
	function update_nearest_date_[% near %]()
	{	
		$("#[% near %]").html("<img src='/files/autoform_wait.gif'>");
		$.get("[% vcs_tools %]get_nearest.htm", {
			'center': $('#center').val(), 
			'persons': 1, 
			'urgent':0 }, 
			function(data) {
				$("#[% near %]").html(data);
			}
		);
		
		var selected_el = $('#vtype').val();
		var restore_el = 0;
		
		$('#vtype').hide();
		$('#vtype').parent().prepend("<img id='tmp_img' src='/files/autoform_wait.gif'>");
		$('#vtype').find('option').remove();
		
		$.get("[% vcs_tools %]get_vtypes.htm", 
			{ 'center': $('#center').val() }, 
			function(xml) {
				$(xml).find('node').each( function() {
					$('#vtype').append('<option value="' + $(this).find('id').text() + '"'+(parseInt($(this).find('default').text()) ? ' selected'  : '')+'>'+$(this).find('title').text() + '</option>');
				
					if ($(this).find('id').text() == selected_el) { restore_el = 1; };
				});
				
				if (restore_el) {
					$('#vtype').val(selected_el);
				}
				$('#tmp_img').remove();
				$('#vtype').show();
				
			}, 
		'xml');
	}
[% END %]

[% FOREACH timeslot IN special.timeslots %]

	update_timeslots();

	function update_timeslots(date_change) {
				
		$('#timeslot').hide();
		$('#timeslot').find('option').remove();
		$('#timeslot').parent().prepend("<img id='tmp_img' src='/files/autoform_wait.gif'>");
		
		var reload_timeslot = $('#timeslot').attr('data-timeslot');

		$.get("[% vcs_tools %]get_times.htm", {
			'center': '[% appinfo.center %]', 
			'persons': '[% appinfo.persons %]', 
			'appdate':$('#app_date').val(),
			'fdate': '[% appinfo.fdate %]', 
			'lang': 'ru',
			
			}, function(xml) {
				$(xml).find('node').each( function() {
					var apptimeValue = $(this).find('id').text();
					var apptimeText = $(this).find('title').text();

					if ( ( apptimeValue == "" ) || ( apptimeValue == reload_timeslot ) ) {
						$('#timeslot').append('<option value="' + apptimeValue + '" selected >'+ apptimeText + '</option>');
					} else {
						$('#timeslot').append('<option value="' + apptimeValue + '">'+ apptimeText + '</option>');
					}
				
			});
			
			$('#tmp_img').remove();
			$('#timeslot').show();
			
			[% IF last_error_name == 'timeslot' %]
				if ( !date_change ) {
					$(document).ready(function() {
						show_error_tip();
					});
				} else {
					$('#timeslot').poshytip('destroy');
				}
			[% END %]
			
			var al = $(xml).find('urgent_flag');
			if (al.text() != '') {
				var alertText = al.text();
				alert(alertText);
			}
	    }, 'xml');
	};
[% END %]

[% IF last_error_name %]

	[% IF last_error_name != 'timeslot' %]
		$(document).ready(function() {
			show_error_tip();
		});
	[% END %]

	function find_pos(obj) {
		var curtop = 0;
		if (obj.offsetParent) {
			do {
				curtop += obj.offsetTop;
			} while (obj = obj.offsetParent);
			return [curtop];
		}
	}

	function show_error_tip() {
		var mobScreen = isMobile();
		var error_x = ( mobScreen ? 'inner-left' : 'left' );
		var error_y = ( mobScreen ? 'top' : 'center' );
		var offset_x = ( mobScreen ? 0 : 5 );
		var offset_y = ( mobScreen ? 5 : 0 );
		
		[% IF last_error_name == 'captha_div' %]
			error_x = 'inner-left';
			offset_x = ( mobScreen ? 0 : 20 );
		[% END %]
		
		window.scroll(0,find_pos(document.getElementById("[% last_error_name %]")));
		
		$('#[% last_error_name %]').poshytip({
			className: 'tip-redsimple',
			content: '[% langreq(last_error_text) %]',
			showOn: 'none',
			alignTo: 'target',
			alignX: error_x,
			alignY: error_y,
			offsetX: offset_x,
			offsetY: offset_y,
		});
		$('#[% last_error_name %]').poshytip('show');
		
		[% IF last_error_name == 'captha_div' %]
			$('.tip-redsimple').each( function() {
				$(this).css('top', (parseFloat($(this).css('top')) + 38) );
			});
		[% ELSE %]
			$('#[% last_error_name %]').css({'background-color' : '#FF9999'});
		[% END %]
	}
[% END %]

[% FOREACH post_index IN special.post_index %]

	$('#[% post_index %]').autocomplete({
		source:function( request, response ) {
			$('#[% post_index %]').hide();
			$('#[% post_index %]').parent().append(
				'<span id="[% post_index %]_replacer">' + $('#[% post_index %]').val() + 
				' <img src="/files/autoform_wait.gif"></span>'
			);
			$('#[% post_index %]_replacer').css( "font-size", ( isMobile() ? '1.5em' : '' ) );
			
			$.ajax({
				url: "/autoform/findpcode.htm",
				dataType: "jsonp",
				data: {
					maxRows: 8,
					name_startsWith: request.term,
					center: [% appinfo.center %], 
				},
				success: function( data ) {
					$('#[% post_index %]').poshytip('hide');
					$('#[% post_index %]_replacer').remove();
					$('#[% post_index %]').show();
					response( $.map( data.cmps, function( item ) {
						return {
							value: item.pcode,
							desc: item.cname,
							cdefault: item.cdefault,
							cid: item.cid
						}
					}));
				}
			});
		},
		delay:10,
		minLength:3,
		select: function( event, ui ) {
			$('#[% post_index %]').val( ui.item.value + ', ' + ui.item.desc );
			return false;
		},
		open: function(event, ui) {
			//$('#[% post_index %]').val( '' );
		}		
	})
	.data( "autocomplete" )._renderItem = function( ul, item ) {
		return $( "<li></li>" )
			.data( "item.autocomplete", item )
			.append( "<a>" + item.value + '<br><span class="post_index">' + item.desc + "</span></a>" )
			.appendTo( ul );
	};
[% END %]
	
</script>

</div>
